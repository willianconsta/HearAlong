<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HearAlong</title>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        .videoContainer {
            padding: 5px;
        }

        .videoContainer::before,
        .videoContainer::after {
            clear: both;
        }

        .videoThumbnail {
            margin-right: 5px;
            float: left;
        }
    </style>
</head>
<body>
<div style="text-align: center">
    <div>FIESTA!</div>
    <input id="newVideo" type="text">
    <button onclick="suggest()">Add to queue</button>
    <button onclick="skip()">Skip</button>
</div>
<div id="video">

</div>
<div id="info" style="text-align: center">
    <div id="current" style="text-align: center"></div>
    <div id="queue_div" style="text-align: center">
        <ol id="queue">
        </ol>
    </div>
</div>

<form id="search">
    <label>search
        <input type="text" name="searchInput"/>
    </label>
    <input type="submit"/>

    <div id="results"></div>
</form>

<div id="users"></div>

<script>
    var serverUrl = 'http://' + window.location.hostname + ':9672';
    console.log('Connecting to ', serverUrl);
    var socket = io.connect(serverUrl);

    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.
    var player;
    var playerReady = false;
    var currentVideo = null;

    // callback utilizada pelo youtube api
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('video', {
            height: '0',
            width: '0',
            playerVars: {'controls': 0},
            events: {
                'onReady': function () {
                    playerReady = true;
                },
                'onStateChange': function (state) {
                    if (state.data === YT.PlayerState.PLAYING) {
                        document.getElementById('current').innerText = player.getVideoData().title;
                    }
                    if (state.data === YT.PlayerState.ENDED || state.data === YT.PlayerState.VIDEO_CUED) {
                        if (currentVideo != null) {
                            var queue = document.getElementById('queue');
                            if (queue.childElementCount > 25) {
                                queue.removeChild(queue.lastElementChild);
                            }
                            var lastPlayed = document.createElement('li');
                            lastPlayed.innerHTML = "<a href='https://www.youtube.com/watch?v=" + currentVideo.url + "'>" + document.getElementById('current').innerText + "</a>";
                            queue.insertBefore(lastPlayed, queue.firstElementChild);
                            document.getElementById('current').innerText = '';
                            console.log('Video ended.');
                            skip();
                            currentVideo = null;
                        }
                    }
                }
            }
        });
    }

    function suggest() {
        const input = document.getElementById('newVideo');
        var videoInput = input.value;

        function extractVideoId() {
            var httpsRegex = /https:\/\/www.youtube.com\/watch\?v=(.{11})/g;
            var matchHttps = httpsRegex.exec(videoInput);
            if (matchHttps != null) {
                return matchHttps[1];
            }

            var httpRegex = /http:\/\/www.youtube.com\/watch\?v=(.{11})/g;
            var httpMatch = httpRegex.exec(videoInput);
            if (httpMatch != null) {
                return httpMatch[1];
            }

            var videoIdRegex = /(.{11})/g;
            var videoIdMatch = videoIdRegex.exec(videoInput);
            if (videoIdMatch != null) {
                return videoIdMatch[1];
            }

            return null;
        }

        var videoId = extractVideoId();
        console.log('Video id ', videoId);
        if (videoId == null) {
            return;
        }
        sendSuggestion(videoId);
        input.value = "";
    }

    function sendSuggestion(videoId) {
        socket.emit('suggestVideo', {
            url: videoId
        });
    }

    function skip() {
        if (currentVideo != null) {
            socket.emit('endVideo', currentVideo);
        }
    }

    socket.on('stopVideo', function (current) {
        console.log('Server requested stop of video ', current);
        if (currentVideo != null && currentVideo.uuid == current.uuid) {
            console.log('Stopping video.');
            player.stopVideo();
            document.getElementById('current').innerHTML = '';
            currentVideo = null;
        }
    });

    socket.on('playVideo', function (current) {
        console.log('Request video play ', current);
        var t = Math.round(current.startTime / 1000);
        if (currentVideo != null && currentVideo.uuid === current.uuid) {
            // mesmo video atual
            console.log('Same video.');
            if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                var currentTime = player.getCurrentTime();
                console.log('Still playing at ', currentTime);
                // já está tocando, só acerta a posição se estiver muito defasado
                if (Math.abs(currentTime - t) > 3) {
                    console.log('Adjusting time to ', t);
                    player.seekTo(t, true);
                }
                return;
            }
        }

        console.log('New video.');
        currentVideo = current;
        function changeVideoId() {
            setTimeout(function () {
                if (!playerReady) {
                    changeVideoId();
                    return;
                }

                console.log('Playing ', current.url, ' starting at ', t);
                player.loadVideoById(current.url, t);
            }, 100);
        }

        changeVideoId();
    });

    socket.on('usersChanged', function () {
        console.log("usersChanged")
        updateUsers()
    });

    socket.on('connect', function () {
        socket.emit('userConnected');
    })

    updateUsers()
    function updateUsers() {
        var usersDiv = document.getElementById("users")
        getJson("/users", function success(users) {
            usersDiv.innerHTML = users.map(function (user) {
                return user.name || user.hostname || user.ip
            }).sort().join("<br>");
        }, function () {
            usersDiv.innerHTML = "Error loading users";
        })
    }

    function getJson(url, success, failure) {
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                success(JSON.parse(request.responseText));
            } else {
                failure(request.responseText);
            }
        };
        request.onerror = failure;
        request.send();
    }
</script>

<script src="https://apis.google.com/js/api.js"></script>
<script>
    (function () {
        var searchForm = document.getElementById("search");

        gapi.load('client', start);
        function start() {
            // 2. Initialize the JavaScript client library.
            gapi.client.init({
                'apiKey': 'AIzaSyBC-3U4J-I_O7Bxb-K-_NYGeYSBDyot798',
                'discoveryDocs': ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'],
                'scope': 'profile'
            }).then(initializeForm, function (reason) {
                console.error('Error: ', reason);
            });
        }

        // 1. Load the JavaScript client library.

        function initializeForm() {
            searchForm.addEventListener("submit", function (ev) {
                ev.preventDefault();

                var searchQuery = searchForm.searchInput.value;
                return gapi.client.youtube.search.list({
                    q: searchQuery,
                    part: 'id,snippet'
                }).then(function (response) {
                    return response.result;
                }).then(showSearchResults);
            })
        }

        function showSearchResults(results) {
            var resultsContainer = document.createDocumentFragment();
            results.items.forEach(function (video) {
                var videoContainer = document.createElement("div");
                var videoName = document.createElement("h1");
                var videoThumbnail = document.createElement("img");
                var videoSuggestButton = document.createElement("button");
                videoContainer.appendChild(videoThumbnail);
                videoContainer.appendChild(videoName);
                resultsContainer.appendChild(videoContainer);
                videoContainer.appendChild(videoSuggestButton);

                videoContainer.className = "videoContainer";
                videoName.className = "videoName";
                videoThumbnail.className = "videoThumbnail";
                videoSuggestButton.className = "videoSuggestButton";
                videoSuggestButton.addEventListener("click", videoSuggestButtonClick)

                videoName.innerHTML = video.snippet.title;
                videoThumbnail.src = video.snippet.thumbnails.default.url;
                videoSuggestButton.innerHTML = "Suggest";
                videoSuggestButton.dataset.videoId = video.id.videoId;
            });
            var elementById = document.getElementById("results");
            elementById.innerHTML = "";
            elementById.appendChild(resultsContainer);
        }

        function videoSuggestButtonClick(ev) {
            ev.preventDefault();
            sendSuggestion(ev.target.dataset.videoId)
        }
    }())
</script>
</body>
</html>